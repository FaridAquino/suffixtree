<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualizador Suffix Tree de Ukkonen</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        #controls { margin: 20px; width: 80%; text-align: center; }
        textarea { width: 100%; height: 100px; border: 1px solid #ccc; border-radius: 5px; padding: 10px; }
        button { background: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; margin-top: 10px; border-radius: 5px; }
        button:hover { background: #218838; }
        #tree-container { width: 95%; height: 800px; border: 1px solid #ddd; background: white; border-radius: 8px; overflow: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        .node circle { fill: #fff; stroke: steelblue; stroke-width: 3px; cursor: pointer; }
        .node text { font: 12px sans-serif; }
        .link { fill: none; stroke: #ccc; stroke-width: 2px; }
        
        /* Estilo para los Suffix Links */
        .suffix-link { fill: none; stroke: #ff4444; stroke-width: 2px; stroke-dasharray: 5,5; opacity: 0.6; marker-end: url(#arrow); }
        
        .edge-label { font-size: 11px; fill: #555; font-family: monospace; background: white; }
        .edge-rect { fill: white; opacity: 0.8; }
    </style>
</head>
<body>

<div id="controls">
    <h3>Visualizador de Suffix Tree</h3>
    <textarea id="jsonInput" placeholder="Pega aquí el JSON generado por tu C++..."></textarea>
    <br>
    <button onclick="drawTree()">Renderizar Árbol</button>
</div>

<div id="tree-container"></div>

<script>
function drawTree() {
    const input = document.getElementById('jsonInput').value;
    if(!input.trim()) return alert("Por favor pega el JSON primero");

    let treeData;
    try {
        treeData = JSON.parse(input);
    } catch(e) {
        return alert("JSON inválido. Asegúrate de copiar todo desde { hasta }");
    }

    d3.select("#tree-container").selectAll("*").remove();

    const width = 1200;
    const height = 800;
    
    const svg = d3.select("#tree-container").append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(d3.zoom().on("zoom", (event) => {
            g.attr("transform", event.transform);
        }))
        .append("g")
        .attr("transform", "translate(50,50)");

    svg.append("defs").append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 18)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", "#ff4444");

    const root = d3.hierarchy(treeData);
    const treeLayout = d3.tree().size([width - 100, height - 200]);
    treeLayout(root);

    const nodeMap = {};
    root.descendants().forEach(d => {
        nodeMap[d.data.name] = d;
    });

    const link = svg.selectAll(".link")
        .data(root.links())
        .enter().append("g")
        .attr("class", "link-group");

    link.append("path")
        .attr("class", "link")
        .attr("d", d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y));

    const labelGroup = link.append("g")
        .attr("transform", d => {
            const x = (d.source.x + d.target.x) / 2;
            const y = (d.source.y + d.target.y) / 2;
            return `translate(${x},${y})`;
        });

    labelGroup.append("rect")
        .attr("class", "edge-rect")
        .attr("x", -10).attr("y", -10)
        .attr("width", 20).attr("height", 20);

    labelGroup.append("text")
        .attr("class", "edge-label")
        .attr("dy", ".35em")
        .attr("text-anchor", "middle")
        .text(d => d.target.data.edgeLabel);

    const suffixLinks = [];
    root.descendants().forEach(d => {
        if (d.data.suffixLink && nodeMap[d.data.suffixLink]) {
            suffixLinks.push({source: d, target: nodeMap[d.data.suffixLink]});
        }
    });

    svg.selectAll(".suffix-link")
        .data(suffixLinks)
        .enter().append("path")
        .attr("class", "suffix-link")
        .attr("d", d => {
            const path = d3.path();
            path.moveTo(d.source.x, d.source.y);
            path.quadraticCurveTo(
                (d.source.x + d.target.x) / 2 + 30,
                (d.source.y + d.target.y) / 2,
                d.target.x, d.target.y
            );
            return path.toString();
        });

    const node = svg.selectAll(".node")
        .data(root.descendants())
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x},${d.y})`);

    node.append("circle")
        .attr("r", 10)
        .style("fill", d => d.children ? "#fff" : "#ffcc00");

    node.append("text")
        .attr("dy", -15)
        .attr("text-anchor", "middle")
        .text(d => d.data.name);
}
</script>

</body>
</html>